# Story 3.6: SDK Pattern Validation Examples for Kubernetes

## Status
Ready for Implementation

## Story
**As a** developer using the AegisSDK,
**I want** comprehensive example projects that validate critical SDK patterns in a Kubernetes environment,
**so that** I can verify Event Patterns, Single-Active services, and Observability features work correctly in production-like K8s deployments.

## Acceptance Criteria
1. Create a comprehensive trading-simulator example that runs exclusively in Kubernetes environment
2. Must be deployable via `./aegis bootstrap -p trading-simulator` and Helm charts
3. Must validate all critical patterns not covered by echo-service:
   - Event Publishing/Subscription with COMPETE, BROADCAST, and EXCLUSIVE modes
   - SingleActiveService with automatic client retry and failover
   - Observability with metrics collection and health reporting
4. Examples must demonstrate real-world scenarios with observable K8s behavior
5. Clear documentation showing deployment steps and expected validation results
6. Integration tests that verify pattern behavior in K8s cluster

## Tasks / Subtasks
- [ ] Task 1: Clear existing examples and prepare new structure (AC: 1)
  - [ ] Remove all content from packages/aegis-sdk-examples
  - [ ] Create new structure for integrated K8s examples
  - [ ] Setup shared K8s deployment configurations

- [ ] Task 2: Implement trading-simulator example (AC: 2, 3, 4)
  - [ ] Create project via `aegis bootstrap -p trading-simulator`
  - [ ] Implement MarketDataPublisher (Event Publisher pattern)
  - [ ] Implement OrderProcessor (SingleActiveService with client retry)
  - [ ] Implement RiskMonitor (BROADCAST subscriber)
  - [ ] Implement ExecutionEngine (COMPETE subscriber)
  - [ ] Implement MetricsCollector (Observability pattern)
  - [ ] Create Helm chart for K8s deployment
  - [ ] Add comprehensive logging to show pattern behavior

- [ ] Task 3: Create comprehensive testing scenarios (AC: 4, 6)
  - [ ] SingleActive failover test scenario
  - [ ] BROADCAST mode consistency test
  - [ ] COMPETE mode load balancing test
  - [ ] Order matching accuracy test
  - [ ] Position aggregation test
  - [ ] Performance benchmark tests

- [ ] Task 4: Create K8s deployment and validation scripts (AC: 4, 5)
  - [ ] Deploy script that uses Helm to install examples
  - [ ] Validation script that verifies each pattern behavior
  - [ ] Port-forwarding setup for local observation
  - [ ] Cleanup script for removing test deployments

- [ ] Task 5: Write comprehensive documentation (AC: 5)
  - [ ] K8s deployment guide for each example
  - [ ] Pattern validation checklist
  - [ ] Expected output and behavior documentation
  - [ ] Troubleshooting guide for K8s issues

- [ ] Task 6: Create integration tests for K8s validation (AC: 6)
  - [ ] Test event publishing from multiple K8s pods
  - [ ] Test COMPETE mode load balancing across pods
  - [ ] Test BROADCAST mode all-pod delivery
  - [ ] Test EXCLUSIVE mode single-pod targeting
  - [ ] Test SingleActiveService failover in K8s
  - [ ] Test metrics collection across cluster
  - [ ] Test health reporting and monitoring

## Dev Notes

### Previous Story Context
From Story 3.4 (SDK Developer Experience):
- Initial SDK examples were too complex for direct development
- Led to creation of aegis-sdk-dev package with `aegis bootstrap` command
- Need simpler, K8s-focused examples using the new bootstrap approach

From echo-service validation:
- Successfully validated round-robin RPC calls across 3 K8s replicas
- Running in aegis-trader namespace with NATS cluster
- Shows basic Service pattern working in K8s

### Current K8s Environment (Verified)
```
Namespace: aegis-trader
NATS: aegis-trader-nats-0 (StatefulSet, 2/2 containers)
Echo Service: 3 replicas running (validated round-robin)
Monitor API/UI: Running on ports 8100/3100
NATS Service: ClusterIP on port 4222
```

### Example 1: trading-simulator
**Purpose**: Simulate a complete trading system with order matching engine (mimics vnpy_ctp)

**Architecture Documentation**: See [trading-simulator-architecture.md](../trading-simulator-architecture.md) for detailed system design, data flows, and implementation details.

**Core Components**:

1. **TradingGateway** (Simulated CTP Gateway)
   - Mimics vnpy_ctp interface with full order lifecycle
   - Order matching engine with price-time priority
   - Maintains order book for multiple symbols
   - Generates realistic trade executions
   - Callbacks: on_order, on_trade, on_position
   - Methods: send_order, cancel_order, query_position

2. **MarketDataService** (Event Publisher)
   - Generates realistic tick data (bid/ask spreads)
   - Publishes TickData events to "market.tick.{symbol}"
   - Simulates market depth with 5-level quotes
   - Multiple pods for different market symbols
   - Validates: Event publishing pattern

3. **OrderManagementService** (SingleActiveService)
   - Single-active with leader election
   - Receives orders via RPC: buy, sell, cancel
   - Validates orders (risk checks, position limits)
   - Routes orders to TradingGateway
   - Client retry on NOT_ACTIVE errors
   - Validates: Sticky single-active pattern

4. **RiskMonitor** (BROADCAST Subscriber)
   - Subscribes to "trades.*" in BROADCAST mode
   - All pods maintain complete position view
   - Calculates real-time PnL and exposure
   - Monitors position limits and risk metrics
   - Validates: Broadcast subscription

5. **ExecutionAlgo** (COMPETE Subscriber)
   - Subscribes to "orders.algo.*" in COMPETE mode
   - Load-balanced algo order processing
   - Implements TWAP/VWAP execution
   - Only one pod processes each algo order
   - Validates: Compete mode load balancing

6. **PositionTracker** (Observability)
   - Aggregates positions across all accounts
   - Enriches ServiceInstance.metadata with positions
   - Exposes metrics: volume, PnL, exposure
   - Validates: Metadata enrichment pattern


### Data Models
Data models follow vnpy conventions for compatibility with real trading systems. See architecture document for detailed model definitions including:
- **TickData**: Market quotes with bid/ask spreads
- **OrderData**: Order lifecycle with status tracking
- **TradeData**: Execution records
- **PositionData**: Position and PnL tracking
- **BarData**: K-line/candlestick data



### Validation Checklist
**Event Publishing**:
- [ ] Multiple pods can publish to same topic
- [ ] Events are delivered reliably
- [ ] Event ordering is preserved per publisher

**Event Subscription Modes**:
- [ ] COMPETE: Only one pod processes each event
- [ ] BROADCAST: All pods receive all events
- [ ] EXCLUSIVE: Only targeted pod receives events

**Single-Active Pattern**:
- [ ] Only one pod is active at a time
- [ ] Clients retry automatically on NOT_ACTIVE
- [ ] Failover completes within 2 seconds
- [ ] State is preserved across failovers

**Observability**:
- [ ] Metrics appear in ServiceInstance.metadata
- [ ] Health checks report to registry
- [ ] Monitor-api can read metrics

### File Structure
```
/packages/aegis-sdk-examples/
├── README.md                           # Overview and quick start
├── trading-simulator/                  # Generated via aegis bootstrap
│   ├── domain/                        # DDD domain layer
│   │   ├── models.py                 # Trading data models
│   │   ├── order_book.py             # Order matching logic
│   │   └── services.py               # Domain services
│   ├── application/                   # Use cases
│   │   ├── order_service.py          # Order management
│   │   ├── risk_service.py           # Risk monitoring
│   │   └── algo_service.py           # Algo execution
│   ├── infra/                        # Infrastructure
│   │   ├── gateway.py                # Trading gateway impl
│   │   ├── market_data.py            # Market data generator
│   │   └── adapters.py               # SDK adapters
│   ├── k8s/                          # Kubernetes manifests
│   │   ├── Chart.yaml
│   │   ├── values.yaml
│   │   └── templates/
│   │       ├── gateway.yaml
│   │       ├── order-mgmt.yaml
│   │       ├── market-data.yaml
│   │       ├── risk-monitor.yaml
│   │       └── execution-algo.yaml
│   ├── main.py
│   ├── pyproject.toml
│   └── tests/
│       ├── test_matching.py
│       ├── test_failover.py
│       └── test_events.py
├── scripts/
│   ├── deploy.sh                     # Deploy trading simulator
│   ├── validate-patterns.sh          # Run validation tests
│   ├── port-forward.sh              # Setup local access
│   └── cleanup.sh                   # Remove deployments
└── docs/
    ├── architecture.md               # Detailed architecture
    ├── deployment.md                 # K8s deployment guide
    └── validation.md                 # Pattern validation guide
```

### Technical Requirements
- Python 3.13+ with full type annotations
- All examples use aegis-sdk-dev bootstrap structure
- Must run in aegis-trader K8s namespace
- Use existing NATS cluster (no new infrastructure)
- Observable behavior via kubectl logs
- Support for port-forwarding for local testing

### Testing Strategy
1. **Unit Tests**: Each component tested in isolation
2. **Integration Tests**: Pattern validation in K8s
3. **E2E Tests**: Complete scenario execution
4. **Chaos Tests**: Failover and recovery validation

### Success Metrics
- All subscription modes verified working
- Single-active failover < 2 seconds
- Metrics visible in monitor-api
- Zero message loss during failover
- Examples deployable in < 5 minutes

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-08 | 1.0 | Initial story creation for K8s pattern validation | Bob (Scrum Master) |

## QA Results
[To be filled by QA]
