{{- if .Values.nats.enabled }}
apiVersion: v1
kind: Pod
metadata:
  name: "{{ include "aegis-trader.fullname" . }}-nats-test"
  labels:
    {{- include "aegis-trader.labels" . | nindent 4 }}
    app.kubernetes.io/component: test
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  restartPolicy: Never
  containers:
  - name: nats-test
    image: nats:alpine
    command:
    - sh
    - -c
    - |
      set -e
      echo "Testing NATS connectivity..."
      nats server check connection --server={{ include "aegis-trader.natsUrl" . }}
      echo "✓ NATS connection successful"
      
      echo "Testing JetStream..."
      nats server check jetstream --server={{ include "aegis-trader.natsUrl" . }}
      echo "✓ JetStream is enabled"
      
      echo "Checking KV bucket..."
      nats kv ls --server={{ include "aegis-trader.natsUrl" . }} | grep -q "{{ .Values.serviceRegistry.bucketName }}"
      echo "✓ KV bucket '{{ .Values.serviceRegistry.bucketName }}' exists"
      
      echo "All NATS tests passed!"
{{- end }}