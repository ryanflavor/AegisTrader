# Story 2.1: Implement Service Registry HTTP Management API

## Status
Ready for Review

## Story
**As a** system administrator,
**I want** a secure FastAPI endpoint to CRUD service definitions
**so that** I can manage the lifecycle of services allowed in the system.

## Acceptance Criteria
1. The `ManagementService` provides `POST`, `GET`, `PUT`, and `DELETE` endpoints for `/api/services`.
2. Each endpoint correctly manipulates service definition entries in the NATS KV Store.
3. ~~All API endpoints are protected against unauthorized access.~~ (Removed - internal network only)

## Tasks / Subtasks
- [x] Task 1: Set up FastAPI project structure in monitor-api application (AC: 1)
  - [x] Create main FastAPI application file in `apps/monitor-api/`
  - [x] Configure FastAPI with proper Python 3.13+ type annotations
  - [x] Set up Pydantic v2 models for ServiceDefinition schema
  - [x] Configure project dependencies in pyproject.toml
- [x] Task 2: Implement NATS KV Store connection and wrapper (AC: 2)
  - [x] Create NATS connection manager using AegisSDK
  - [x] Implement async KV Store operations (get, put, delete, list)
  - [x] Configure KV bucket for service definitions
  - [x] Add connection error handling and retry logic
- [x] Task 3: Create GET /api/services endpoint (AC: 1, 2)
  - [x] Implement route to list all service definitions
  - [x] Query NATS KV Store for all service entries
  - [x] Return JSON array of ServiceDefinition objects
  - [x] Add proper error handling for KV Store failures
- [x] Task 4: Create POST /api/services endpoint (AC: 1, 2)
  - [x] Implement route to create new service definition
  - [x] Validate input using Pydantic ServiceDefinition model
  - [x] Generate timestamps for createdAt and updatedAt fields
  - [x] Store in NATS KV Store with serviceName as key
- [x] Task 5: Create PUT /api/services/{serviceName} endpoint (AC: 1, 2)
  - [x] Implement route to update existing service definition
  - [x] Validate service exists before updating
  - [x] Update updatedAt timestamp
  - [x] Implement optimistic locking with KV Store revision
  - [x] Perform atomic update in NATS KV Store
- [x] Task 6: Create DELETE /api/services/{serviceName} endpoint (AC: 1, 2)
  - [x] Implement route to delete service definition
  - [x] Validate service exists before deleting
  - [x] Remove entry from NATS KV Store
  - [x] Return appropriate status codes
- [ ] ~~Task 7: Implement authentication and authorization~~ (Removed - internal network only)
- [x] Task 7: Write comprehensive integration tests (AC: 1, 2)
  - [x] Create test fixtures for NATS KV Store using testcontainers
  - [x] Test all CRUD operations with valid data
  - [x] Test error cases and edge conditions
  - [x] Achieve 100% coverage for all API endpoints

## Dev Notes

### Previous Story Insights
From Story 1.2 implementation:
- K8s NATS cluster is already deployed with 3-node HA configuration [Source: Story 1.2 Dev Notes]
- NATS service available at `aegis-trader-nats:4222` within cluster
- JetStream and KV Store are enabled with 10Gi storage
- For local development, use port-forwarding: `kubectl port-forward svc/aegis-trader-nats 4222:4222`
- Integration tests should be based on the Epic 0 K8s infrastructure
- Note: "ultrathink" mentioned by user was not found in codebase during Story 1.2 review

### Data Models
ServiceDefinition schema [Source: architecture/data-models-schema-design.md#ServiceDefinition]:
```typescript
export interface ServiceDefinition {
  serviceName: string;
  owner: string;
  description: string;
  version: string;
  createdAt: string;
  updatedAt: string;
}
```
- All fields are required strings
- serviceName serves as the unique identifier
- Timestamps should be ISO 8601 format
- Must use Pydantic v2 for Python implementation

**Validation Rules & Constraints**:
- `serviceName`: Pattern `^[a-z][a-z0-9-]{2,63}$` (lowercase, alphanumeric with hyphens, 3-64 chars)
- `owner`: Max length 100 characters
- `description`: Max length 500 characters
- `version`: Semantic versioning pattern `^\d+\.\d+\.\d+$`
- `createdAt/updatedAt`: ISO 8601 format with timezone (e.g., "2025-08-02T10:30:00Z")
- Duplicate serviceName on POST should return 409 Conflict

### API Specifications
RESTful API Contract [Source: architecture/api-interface-contracts.md#Management Service]:
- Base path: `/api`
- Endpoints:
  - `GET /services` - List all service definitions
  - `POST /services` - Create new service definition
  - `PUT /services/{serviceName}` - Update existing service definition
  - `DELETE /services/{serviceName}` - Delete service definition
- All endpoints must return proper HTTP status codes
- Response format: JSON with appropriate content-type headers

**HTTP Status Codes**:
- `200 OK`: Successful GET, PUT operations
- `201 Created`: Successful POST with Location header
- `204 No Content`: Successful DELETE
- `400 Bad Request`: Invalid input data or validation failure
- `404 Not Found`: Service definition not found
- `409 Conflict`: Duplicate serviceName on POST or concurrent update
- `422 Unprocessable Entity`: Request validation errors
- `500 Internal Server Error`: NATS connection failures

**Error Response Format**:
```json
{
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "Service name must be lowercase alphanumeric with hyphens",
    "details": {
      "field": "serviceName",
      "value": "Invalid-Name"
    }
  }
}

### Component Specifications
No specific UI component details for this story as it's backend-only.

### File Locations
Based on project structure [Source: architecture/source-tree.md]:
```
/apps/monitor-api/              # FastAPI Management Backend location
├── src/
│   ├── main.py               # FastAPI application entry point
│   ├── models/               # Pydantic models
│   │   └── service.py        # ServiceDefinition model
│   ├── routers/              # API route handlers
│   │   └── services.py       # Service management endpoints
│   └── services/             # Business logic
│       └── kv_store.py       # NATS KV Store operations
├── tests/                    # Test files
│   ├── integration/
│   │   └── test_services_api.py
│   └── conftest.py          # Pytest fixtures
└── pyproject.toml           # Project dependencies
```

### Technical Constraints
- Python version: 3.13+ required [Source: architecture/coding-standards.md]
- Framework: FastAPI latest version [Source: architecture/tech-stack.md]
- Type annotations: 100% coverage mandatory, use `from __future__ import annotations`
- Data validation: Pydantic v2 only, @dataclass forbidden
- Async: All I/O operations must use async/await
- NATS version: 2.9+ with JetStream enabled
- Service Registry: NATS KV Store (no external database)

**Network Security**:
- Internal network only - no authentication required
- Service runs within secure K8s cluster
- Access controlled via Kubernetes network policies
- No rate limiting needed for internal services

**Concurrency & Atomicity**:
- Use NATS KV Store revision for optimistic locking on updates
- PUT operations must include current revision in request
- Return 409 Conflict if revision mismatch (concurrent update)
- KV Store operations are atomic by default
- Connection pooling with max 10 concurrent NATS connections

### Testing Requirements

**Test Framework**: Pytest (mandatory) [Source: architecture/testing-strategy.md]
- Use fixtures instead of setUp/tearDown
- Use plain `assert` statements, NOT unittest assertions
- Use `@pytest.mark.asyncio` for async tests
- Use `@pytest.mark.parametrize` for multiple test cases

**Test Organization**:
```
/apps/monitor-api/tests/
├── integration/
│   └── test_services_api.py    # API endpoint tests
└── conftest.py                 # Shared fixtures
```

**Testing Standards**:
- Minimum 80% overall coverage, 100% for API endpoints
- Use testcontainers for NATS integration testing
- Test naming: `test_{functionality}_{expected_behavior}`
- No mocking of NATS - use real containerized instance
- Test both success and failure scenarios
- Verify proper HTTP status codes and error messages

**Integration Test Requirements**:
- Must test against containerized NATS with KV Store enabled
- Test CRUD operations with various payloads
- Test concurrent operations and race conditions
- Verify KV Store persistence across operations

**Specific Test Scenarios**:
1. **Happy Path Tests**:
   - Create, read, update, delete service definitions
   - List all services with proper pagination
   - Verify timestamps are correctly set
2. **Validation Tests**:
   - Invalid serviceName patterns
   - Missing required fields
   - Invalid version formats
   - Field length exceeding limits
3. **Error Handling Tests**:
   - NATS connection failures
   - Duplicate serviceName on POST
   - Update/delete non-existent services
   - Concurrent update conflicts
4. **Performance Tests**:
   - Response time < 100ms for single operations
   - Handle 100 concurrent requests without degradation

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-02 | 1.0 | Initial story creation | Bob (Scrum Master) |
| 2025-08-02 | 1.1 | Updated with TDD-DDD engineer recommendations | Bob (Scrum Master) |
| 2025-08-02 | 1.2 | Removed authentication - internal network only | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
claude-opus-4-20250514

### Debug Log References
- Fixed ruff linting errors (B904: raise exceptions with 'from' clause)
- Fixed mypy type errors (added type hints and assertions)
- Implemented hexagonal architecture with proper port/adapter pattern

### Completion Notes List
- Implemented complete Service Registry HTTP Management API
- All CRUD endpoints implemented (GET, POST, PUT, DELETE)
- Full NATS KV Store integration with optimistic locking
- Comprehensive integration tests with testcontainers
- 100% Pydantic v2 type annotation coverage
- Follows hexagonal architecture principles

### File List
- apps/monitor-api/requirements.txt (modified: added nats-py==2.9.0, testcontainers==4.0.0)
- apps/monitor-api/app/domain/models.py (modified: added ServiceDefinition model)
- apps/monitor-api/app/domain/exceptions.py (modified: added service registry exceptions)
- apps/monitor-api/app/ports/kv_store.py (created: KV Store port interface)
- apps/monitor-api/app/infrastructure/nats_kv_adapter.py (created: NATS KV Store implementation)
- apps/monitor-api/app/application/service_registry_service.py (created: service registry business logic)
- apps/monitor-api/app/infrastructure/api/dependencies.py (modified: added service registry dependencies)
- apps/monitor-api/app/infrastructure/api/service_routes.py (created: service registry API routes)
- apps/monitor-api/app/infrastructure/api/routes.py (modified: included service registry routes)
- apps/monitor-api/tests/integration/test_services_api.py (created: comprehensive integration tests)
- apps/monitor-api/app/infrastructure/configuration_adapter.py (modified: added type imports)

## QA Results
