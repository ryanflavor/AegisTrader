# Story 2.1: Implement Service Registry HTTP Management API

## Status
Draft

## Story
**As a** system administrator,
**I want** a secure FastAPI endpoint to CRUD service definitions
**so that** I can manage the lifecycle of services allowed in the system.

## Acceptance Criteria
1. The `ManagementService` provides `POST`, `GET`, `PUT`, and `DELETE` endpoints for `/api/services`.
2. Each endpoint correctly manipulates service definition entries in the NATS KV Store.
3. All API endpoints are protected against unauthorized access.

## Tasks / Subtasks
- [ ] Task 1: Set up FastAPI project structure in monitor-api application (AC: 1)
  - [ ] Create main FastAPI application file in `apps/monitor-api/`
  - [ ] Configure FastAPI with proper Python 3.13+ type annotations
  - [ ] Set up Pydantic v2 models for ServiceDefinition schema
  - [ ] Configure project dependencies in pyproject.toml
- [ ] Task 2: Implement NATS KV Store connection and wrapper (AC: 2)
  - [ ] Create NATS connection manager using AegisSDK
  - [ ] Implement async KV Store operations (get, put, delete, list)
  - [ ] Configure KV bucket for service definitions
  - [ ] Add connection error handling and retry logic
- [ ] Task 3: Create GET /api/services endpoint (AC: 1, 2)
  - [ ] Implement route to list all service definitions
  - [ ] Query NATS KV Store for all service entries
  - [ ] Return JSON array of ServiceDefinition objects
  - [ ] Add proper error handling for KV Store failures
- [ ] Task 4: Create POST /api/services endpoint (AC: 1, 2)
  - [ ] Implement route to create new service definition
  - [ ] Validate input using Pydantic ServiceDefinition model
  - [ ] Generate timestamps for createdAt and updatedAt fields
  - [ ] Store in NATS KV Store with serviceName as key
- [ ] Task 5: Create PUT /api/services/{serviceName} endpoint (AC: 1, 2)
  - [ ] Implement route to update existing service definition
  - [ ] Validate service exists before updating
  - [ ] Update updatedAt timestamp
  - [ ] Perform atomic update in NATS KV Store
- [ ] Task 6: Create DELETE /api/services/{serviceName} endpoint (AC: 1, 2)
  - [ ] Implement route to delete service definition
  - [ ] Validate service exists before deleting
  - [ ] Remove entry from NATS KV Store
  - [ ] Return appropriate status codes
- [ ] Task 7: Implement authentication and authorization (AC: 3)
  - [ ] Add authentication middleware to FastAPI app
  - [ ] Protect all /api/services endpoints
  - [ ] Configure authorization rules for admin access
  - [ ] Add proper 401/403 error responses
- [ ] Task 8: Write comprehensive integration tests (AC: 1, 2, 3)
  - [ ] Create test fixtures for NATS KV Store using testcontainers
  - [ ] Test all CRUD operations with valid data
  - [ ] Test error cases and edge conditions
  - [ ] Test authentication and authorization
  - [ ] Achieve 100% coverage for all API endpoints

## Dev Notes

### Previous Story Insights
From Story 1.2 implementation:
- K8s NATS cluster is already deployed with 3-node HA configuration [Source: Story 1.2 Dev Notes]
- NATS service available at `aegis-trader-nats:4222` within cluster
- JetStream and KV Store are enabled with 10Gi storage
- For local development, use port-forwarding: `kubectl port-forward svc/aegis-trader-nats 4222:4222`
- Integration tests should be based on the Epic 0 K8s infrastructure
- Note: "ultrathink" mentioned by user was not found in codebase during Story 1.2 review

### Data Models
ServiceDefinition schema [Source: architecture/data-models-schema-design.md#ServiceDefinition]:
```typescript
export interface ServiceDefinition {
  serviceName: string;
  owner: string;
  description: string;
  version: string;
  createdAt: string;
  updatedAt: string;
}
```
- All fields are required strings
- serviceName serves as the unique identifier
- Timestamps should be ISO 8601 format
- Must use Pydantic v2 for Python implementation

### API Specifications
RESTful API Contract [Source: architecture/api-interface-contracts.md#Management Service]:
- Base path: `/api`
- Endpoints:
  - `GET /services` - List all service definitions
  - `POST /services` - Create new service definition
  - `PUT /services/{serviceName}` - Update existing service definition
  - `DELETE /services/{serviceName}` - Delete service definition
- All endpoints must return proper HTTP status codes
- Response format: JSON with appropriate content-type headers

### Component Specifications
No specific UI component details for this story as it's backend-only.

### File Locations
Based on project structure [Source: architecture/source-tree.md]:
```
/apps/monitor-api/              # FastAPI Management Backend location
├── src/
│   ├── main.py               # FastAPI application entry point
│   ├── models/               # Pydantic models
│   │   └── service.py        # ServiceDefinition model
│   ├── routers/              # API route handlers
│   │   └── services.py       # Service management endpoints
│   ├── services/             # Business logic
│   │   └── kv_store.py       # NATS KV Store operations
│   └── middleware/           # Authentication middleware
│       └── auth.py
├── tests/                    # Test files
│   ├── integration/
│   │   └── test_services_api.py
│   └── conftest.py          # Pytest fixtures
└── pyproject.toml           # Project dependencies
```

### Technical Constraints
- Python version: 3.13+ required [Source: architecture/coding-standards.md]
- Framework: FastAPI latest version [Source: architecture/tech-stack.md]
- Type annotations: 100% coverage mandatory, use `from __future__ import annotations`
- Data validation: Pydantic v2 only, @dataclass forbidden
- Async: All I/O operations must use async/await
- NATS version: 2.9+ with JetStream enabled
- Service Registry: NATS KV Store (no external database)

### Testing Requirements

**Test Framework**: Pytest (mandatory) [Source: architecture/testing-strategy.md]
- Use fixtures instead of setUp/tearDown
- Use plain `assert` statements, NOT unittest assertions
- Use `@pytest.mark.asyncio` for async tests
- Use `@pytest.mark.parametrize` for multiple test cases

**Test Organization**:
```
/apps/monitor-api/tests/
├── integration/
│   └── test_services_api.py    # API endpoint tests
└── conftest.py                 # Shared fixtures
```

**Testing Standards**:
- Minimum 80% overall coverage, 100% for API endpoints
- Use testcontainers for NATS integration testing
- Test naming: `test_{functionality}_{expected_behavior}`
- No mocking of NATS - use real containerized instance
- Test both success and failure scenarios
- Verify proper HTTP status codes and error messages

**Integration Test Requirements**:
- Must test against containerized NATS with KV Store enabled
- Test CRUD operations with various payloads
- Test authentication and authorization flows
- Test concurrent operations and race conditions
- Verify KV Store persistence across operations

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-02 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results
