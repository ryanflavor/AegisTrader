# Story 2.2: Integrate SDK Service Registration

## Status
Ready for Review

## Story
**As an** `AegisSDK` service instance,
**I want** to register with the new Registry Service upon startup and send heartbeats
**so that** my existence and health status are persistently tracked.

## Acceptance Criteria
1. On startup, a service instance writes its `ServiceInstance` data to a key in the NATS KV Store.
2. The key is created with a specific TTL (Time-To-Live).
3. The service periodically updates the key to refresh the TTL, acting as a heartbeat.

## Tasks / Subtasks
- [x] Task 1: Create ServiceInstance model in SDK (AC: 1)
  - [x] Add ServiceInstance model to aegis_sdk/domain/models.py
  - [x] Ensure model matches TypeScript interface with Pydantic v2
  - [x] Add validation rules for all fields
  - [x] Write unit tests for model validation
- [x] Task 2: Implement service registration in Service base class (AC: 1)
  - [x] Add registration logic to Service.__init__ or startup method
  - [x] Create ServiceInstance with proper metadata
  - [x] Store instance data in NATS KV Store with serviceName-based key pattern
  - [x] Handle registration failures gracefully
- [x] Task 3: Implement TTL-based key creation (AC: 2)
  - [x] Configure appropriate TTL value (e.g., 30 seconds)
  - [x] Use NATS KV Store TTL feature when creating instance key
  - [x] Ensure key expires if heartbeat stops
  - [x] Write integration tests to verify TTL behavior
- [x] Task 4: Implement heartbeat mechanism (AC: 3)
  - [x] Add heartbeat task to Service base class
  - [x] Update instance key periodically (e.g., every 10 seconds)
  - [x] Update lastHeartbeat timestamp on each refresh
  - [x] Handle heartbeat failures with retry logic
  - [x] Ensure graceful shutdown stops heartbeat
- [x] Task 5: Add configuration options for registration
  - [x] Add optional parameters for TTL and heartbeat interval
  - [x] Allow disabling registration for testing
  - [x] Document configuration options in Service class
- [x] Task 6: Write comprehensive tests (AC: 1, 2, 3)
  - [x] Unit tests for registration logic
  - [x] Integration tests with NATS KV Store using K8s environment
    - [x] Deploy test cluster: `make dev-update`
    - [x] Set up port forwarding: `make port-forward`
    - [x] Connect tests to localhost:4222
  - [x] Test TTL expiration behavior
  - [x] Test heartbeat failure scenarios
  - [x] Achieve 100% coverage for new code

## Dev Notes

### Previous Story Insights
From Story 2.1 implementation:
- NATS KV Store integration is available via AegisKVStoreAdapter
- KV Store operations use AegisSDK infrastructure, not direct nats-py
- UTC+8 timezone standardization implemented across the project
- Service Registry API endpoints are ready at `/api/services`
- NATS cluster available at `aegis-trader-nats:4222` within K8s cluster
- Note: User confirmed SDK supports JetStream TTL KV store on K8s

From Story 0.2 K8s deployment:
- **CRITICAL**: Integration tests MUST use the local K8s environment from Story 0.2
- One-click deployment available via root Makefile: `make dev-update`
- One-click port forwarding: `make port-forward` (exposes NATS on localhost:4222)
- 3-node NATS cluster with JetStream and KV Store enabled
- NATS service: `aegis-trader-nats:4222` (within cluster)

### Data Models
ServiceInstance schema [Source: architecture/data-models-schema-design.md#ServiceInstance]:
```typescript
export interface ServiceInstance {
  serviceName: string;
  instanceId: string;
  version: string;
  status: 'ACTIVE' | 'UNHEALTHY' | 'STANDBY';
  stickyActiveGroup?: string;
  lastHeartbeat: string;
  metadata?: Record<string, any>;
}
```
- All fields except stickyActiveGroup and metadata are required
- status must be one of the enum values
- lastHeartbeat should be ISO 8601 format with UTC+8 timezone
- instanceId should be unique per service instance
- metadata can contain additional service-specific information

### Component Specifications
Service Registration in SDK [Source: component context]:
- Registration happens in Service base class (aegis_sdk/application/service.py)
- Service class already has service_name, instance_id, and version properties
- MessageBusPort is available via self._bus
- NATS KV Store adapter exists at aegis_sdk/infrastructure/nats_kv_store.py

### File Locations
Based on project structure [Source: architecture/source-tree.md]:
```
/packages/aegis-sdk/
├── aegis_sdk/
│   ├── application/
│   │   └── service.py          # Service base class - add registration here
│   ├── domain/
│   │   └── models.py           # Add ServiceInstance model here
│   └── infrastructure/
│       └── nats_kv_store.py    # Existing KV Store implementation with TTL
├── tests/
│   ├── unit/
│   │   ├── application/
│   │   │   └── test_service.py # Add unit tests for registration
│   │   └── domain/
│   │       └── test_models.py  # Add ServiceInstance model tests
│   └── integration/
│       └── test_service_registration.py # New integration tests
```

### Technical Constraints
- Python version: 3.13+ required [Source: architecture/coding-standards.md]
- Type annotations: 100% coverage mandatory with `from __future__ import annotations`
- Data validation: Pydantic v2 only, @dataclass forbidden
- Async: All I/O operations must use async/await
- Service names: Must follow pattern from SubjectPatterns.is_valid_service_name()
- Instance IDs: Format "{service_name}-{uuid_hex[:8]}" already implemented

### KV Store Integration Details
From existing NATSKVStore implementation:
- TTL support already implemented via `_create_kv_stream_with_ttl` method
- Key sanitization handled automatically (spaces, dots replaced with underscores)
- KV bucket operations available through KVStorePort interface
- Connection managed through MessageBusPort (NATSAdapter)
- Metrics collection integrated via MetricsPort

**Integration Test Connection**:
- Use NATS URL: `nats://localhost:4222` (after `make port-forward`)
- KV bucket name: `service-registry` (pre-configured in K8s deployment)
- No authentication required for local development
- Ensure K8s cluster is running before integration tests

### Registration Key Pattern
Suggested key pattern for service instances:
- Pattern: `service-instances.{serviceName}.{instanceId}`
- Example: `service-instances.trading-service.trading-service-a1b2c3d4`
- This allows querying all instances of a service by prefix

### Heartbeat Implementation Notes
- Use asyncio.create_task() for background heartbeat task
- Store task reference to ensure proper cleanup on shutdown
- Consider exponential backoff for heartbeat failures
- Update both KV entry and lastHeartbeat timestamp
- Log heartbeat failures at WARNING level

### Testing Requirements

**Test Framework**: Pytest (mandatory) [Source: architecture/testing-strategy.md]
- Use fixtures instead of setUp/tearDown
- Use plain `assert` statements
- Use `@pytest.mark.asyncio` for async tests
- Use `@pytest.mark.parametrize` for test variations

**Test File Locations**:
```
/packages/aegis-sdk/tests/
├── unit/
│   ├── application/
│   │   └── test_service.py          # Test registration logic
│   └── domain/
│       └── test_models.py           # Test ServiceInstance model
└── integration/
    └── test_service_registration.py # Full registration flow tests
```

**Testing Standards**:
- Minimum 80% overall coverage, 100% for registration code
- **MANDATORY**: Integration tests MUST use local K8s environment from Story 0.2
  - Deploy test environment: `make dev-update` (from project root)
  - Access NATS for testing: `make port-forward` (exposes localhost:4222)
  - Do NOT use testcontainers for NATS - use the deployed K8s cluster
- Test naming: `test_{functionality}_{expected_behavior}`
- No mocking of NATS - use real K8s-deployed instance
- Test both success and failure scenarios

**Specific Test Scenarios**:
1. **Registration Tests**:
   - Successful registration on service startup
   - Registration with custom TTL values
   - Registration failure handling
   - Duplicate instance ID handling
2. **Heartbeat Tests**:
   - Regular heartbeat updates
   - TTL refresh verification
   - Heartbeat task cancellation on shutdown
   - Heartbeat failure recovery
3. **TTL Expiration Tests**:
   - Key expires when heartbeat stops
   - Key removed from KV store after TTL
   - Other instances can detect expired keys
4. **Integration Tests**:
   - Full registration and heartbeat flow
   - Multiple service instances registering
   - Service discovery after registration
   - Concurrent registration handling

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-03 | 1.0 | Initial story creation | Bob (Scrum Master) |
| 2025-08-03 | 1.1 | Added emphasis on K8s environment for integration testing | Bob (Scrum Master) |
| 2025-08-03 | 1.2 | Completed implementation of service registration with TTL and heartbeat | James (Developer) |

## Dev Agent Record

### Agent Model Used
claude-opus-4-20250514

### Debug Log References
- Created ServiceInstance model with Pydantic v2 validation
- Added imports and exports to domain layer
- Implemented service registration in Service base class
- Added KV store integration with TTL support
- Implemented heartbeat mechanism with registry updates
- Added configuration options for TTL and heartbeat interval

### Completion Notes List
- ServiceInstance model created with all required fields and validation
- Service base class enhanced with automatic registration on startup
- Registration key pattern: `service-instances.{serviceName}.{instanceId}`
- Default TTL: 30 seconds, configurable via constructor
- Default heartbeat interval: 10 seconds, configurable via constructor
- Registration can be disabled for testing via `enable_registration=False`
- Heartbeat updates both NATS message bus and KV store entry
- Service status changes are reflected in registry
- Graceful handling of registration failures and KV store errors
- Re-registration occurs if entry is lost during heartbeat

### File List
- Modified: `/packages/aegis-sdk/aegis_sdk/domain/models.py` - Added ServiceInstance model
- Modified: `/packages/aegis-sdk/aegis_sdk/domain/__init__.py` - Exported ServiceInstance
- Modified: `/packages/aegis-sdk/aegis_sdk/application/service.py` - Added registration logic
- Created: `/packages/aegis-sdk/aegis_sdk/ports/service_registry.py` - Service registry port interface
- Created: `/packages/aegis-sdk/aegis_sdk/infrastructure/kv_service_registry.py` - KV store implementation of registry
- Modified: `/packages/aegis-sdk/tests/unit/domain/test_models.py` - Added ServiceInstance tests
- Modified: `/packages/aegis-sdk/tests/unit/application/test_service.py` - Added registration unit tests
- Created: `/packages/aegis-sdk/tests/unit/infrastructure/test_kv_service_registry.py` - Unit tests for KV registry
- Modified: `/packages/aegis-sdk/tests/unit/domain/test_value_objects.py` - Fixed InstanceId test
- Modified: `/packages/aegis-sdk/tests/conftest.py` - Added mock_kv_store and mock_logger fixtures
- Created: `/packages/aegis-sdk/tests/integration/test_service_registration.py` - Integration tests for registration
- Modified: `/packages/aegis-sdk/tests/integration/infrastructure/test_nats_kv_store_ttl_integration.py` - Fixed TTL test

## QA Results
